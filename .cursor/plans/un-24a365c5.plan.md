<!-- 24a365c5-0c79-43c7-9518-cde08451be4b d0685350-8333-4d3a-a628-e49f19f17e3c -->
# Unified Per-User Colors Across Cursor, Selection, Presence

## Approach

- Deterministic color per user: derive from `userId` using existing hash â†’ HSL in `Canvas.tsx` (stable across rooms).
- Propagate color via existing channels:
  - Remote cursor: already writes `color` with cursor updates.
  - Shape selection: already writes `selectedBy` with `{ userId, color, name }` on edit.
  - Local overlays and presence UI: wire color through components.

## Key References

- Color derivation exists:
```107:116:src/components/Canvas/Canvas.tsx
  const colorFromId = useMemo(() => {
    const str = selfId
    let hash = 0
    for (let i = 0; i < str.length; i++) {
      hash = (hash << 5) - hash + str.charCodeAt(i)
      hash |= 0
    }
    const hue = Math.abs(hash) % 360
    return `hsl(${hue}, 70%, 50%)`
  }, [selfId])
```

- Remote cursor already uses `c.color`:
```10:16:src/components/Canvas/CursorLayer.tsx
  <Line
    points={[c.x, c.y, c.x - 8, c.y + 16, c.x + 8, c.y + 16]}
    closed
    fill={c.color}
    stroke={c.color}
  />
```

- Local selection currently lacks color prop; remote selection passes it:
```713:733:src/components/Canvas/Canvas.tsx
  <ShapeEditor
    shape={s as any}
    isSelected={isSelected}
    onChange={(next) => {
      updateShape(id, next as any)
      const latest = { ...s, ...next, selectedBy: state.byId[id]?.selectedBy }
      writers.update && writers.update(latest as any)
    }}
    onCommit={() => {
      const latest = state.byId[id]
      if (latest) writers.update && writers.update({ ...latest, selectedBy: state.byId[id]?.selectedBy } as any)
    }}
    onBeginEdit={() => beginEdit(id)}
    onEndEdit={() => endEdit(id)}
  />
  {s.selectedBy?.userId && s.selectedBy.userId !== selfId && (
    <ShapeEditor
      shape={s as any}
      isSelected
      selectionColor={s.selectedBy.color}
      interactive={false}
      onChange={() => {}}
    />
  )}
```

- Drag-selection box has hardcoded color:
```12:13:src/components/Canvas/SelectionBox.tsx
  stroke="#1976d2"
```

- Presence list shows names only:
```26:31:src/components/Presence/PresenceList.tsx
  return (
    <div className="presenceList" aria-label="active-users">
      {names.map((n, idx) => (
        <span key={`${n}-${idx}`} className="presencePill">{n}</span>
      ))}
```


## Changes

1. Local selection overlay color

   - Pass `selectionColor={colorFromId}` to the local `ShapeEditor` in `Canvas.tsx`.

2. Drag-selection marquee color

   - Extend `SelectionBox` to accept `color` prop and use it for `stroke`.
   - Pass `color={colorFromId}` from `Canvas.tsx` when rendering active selection rectangle.

3. Presence display color

   - Update `PresenceList` to render each user with their `c.color` (from `allCursors`).
   - Minimal UI: add a small colored dot and use that color; keep readable text.
   - Optional: light border tint using inline style; avoid global CSS complexity.

4. Keep cursor and remote selection as-is; they already use the color from Firestore payloads.

## Notes

- Scope confirmed: 1a (deterministic per `userId`), 2a (use user color for marquee).
- Tests should continue to pass; presence tests check names and counts only. We can add an optional new test for colored dot presence later.

### To-dos

- [ ] Pass selectionColor={colorFromId} to local ShapeEditor in Canvas.tsx
- [ ] Add color prop to SelectionBox and use it for stroke
- [ ] Pass colorFromId to SelectionBox in Canvas.tsx
- [ ] Render colored dot/pill using c.color in PresenceList.tsx
- [ ] Add minimal styles for presence dot (or use inline style)